<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="">
    <meta name="author" content="">

    <title>MSB Mastercard World Elite</title>

    <!-- CSS FILES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200;0,400;0,600;0,700;1,200;1,700&display=swap"
        rel="stylesheet">

    <link href="css/bootstrap.min.css" rel="stylesheet">

    <link href="css/bootstrap-icons.css" rel="stylesheet">

    <link href="css/vegas.min.css" rel="stylesheet">

    <link href="css/tooplate-barista.css" rel="stylesheet">

</head>

<body>

    <main>
        <nav class="navbar navbar-expand-lg">
            <div class="container position-relative">
                <a class="navbar-brand d-flex align-items-center" href="index.html">
                    <img src="images/msb-logo1.png" class="navbar-brand-image img-fluid" alt="MSB Logo">
                    <span class="navbar-brand-text">MSB</span>
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-lg-auto">
                        <li class="nav-item">
                            <div class="navbar-center-absolute d-none d-lg-block">AI Arena - Khối QLRR - MasterCard
                                World Elite</div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <section class="barista-section section-padding section-bg" id="barista-team">
            <div class="container">
                <div class="row justify-content-center">

                    <div class="col-lg-12 col-12 text-center mb-4 pb-lg-2">
                        <h2 class="text-white3">Kit 1: Giới thiệu sản phẩm</h2>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="index.html" target="_blank" style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-image-wrap1">
                                    <img src="images/Untitled1.png"
                                        class="team-block-image" alt="">
                                </div>
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Landing page</h4>
                                    </div>
                                    <p class="text-white mb-0">Trọn vẹn, dễ chia sẻ</p>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://www.canva.com/design/DAGpHvEMwkc/z3ZRdi50UqlC2TuSDx1JnA/view" target="_blank"
                            style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-image-wrap1">
                                    <img src="images/WE Black and Gold Poster .png" class="team-block-image" alt="">
                                </div>
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Poster</h4>
                                    </div>
                                    <p class="text-white mb-0">Ấn tượng tức thì – dễ lan tỏa</p>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://www.canva.com/design/DAGqCSFjWOU/rIlTTQ43YR41mMZs7CvONQ/view" target="_blank"
                            style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-image-wrap1">
                                    <img src="images/Brochure WE.png" class="team-block-image" alt="">
                                </div>
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Brochure</h4>
                                    </div>
                                    <p class="text-white mb-0">Gấp gọn, dễ đọc, dễ nhớ</p>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="videos/edit video kit1 gioi thieu WE 720P.mp4" target="_blank"
                            style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-image-wrap1">
                                    <img src="images/Video.png" class="team-block-image" alt="">
                                </div>
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Video</h4>
                                    </div>
                                    <p class="text-white mb-0">Truyền tải sinh động</p>
                                </div>
                            </div>
                        </a>
                    </div>

                </div>
            </div>


            <div class="container">
                <div class="row justify-content-start">

                    <div class="col-lg-12 col-12 text-center mb-4 pb-lg-2">
                        <h2 class="text-white3">Kit 2: Quy trình</h2>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://www.canva.com/design/DAGqCwYAvHw/OPsAury8Yo1RePZt0J9AQw/view" target="_blank" style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Catalog</h4>
                                    </div>
                                    <p class="text-white mb-0">Khám phá toàn bộ sản phẩm</p>
                                </div>
                                <div class="team-block-image-wrap1">
                                    <img src="images/Full Catalog WE.png"
                                        class="team-block-image img-fluid" alt="">
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://www.canva.com/design/DAGqIFIWT0A/SKX_IoEnfuwgAparN3sAGw/view" target="_blank" style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Guide</h4>
                                    </div>
                                    <p class="text-white mb-0">Bảo hiểm du lịch</p>
                                </div>
                                <div class="team-block-image-wrap1">
                                    <img src="images/HD bảo hiểm du lịch (1).png"
                                        class="team-block-image img-fluid" alt="">
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://www.canva.com/design/DAGqHeDLkPM/U3_Sab7dCCrWOI_ALdrDmw/view" target="_blank" style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Guide</h4>
                                    </div>
                                    <p class="text-white mb-0">Phòng chờ thương gia</p>
                                </div>
                                <div class="team-block-image-wrap1">
                                    <img src="images/HD đăng ký phòng chờ Thương Gia.png"
                                        class="team-block-image img-fluid" alt="">
                                </div>
                            </div>
                        </a>
                    </div>                    


                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://mastercardworldelite.my.canva.site/brochure" target="_blank"
                            style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Video</h4>
                                    </div>
                                    <p class="text-white mb-0">Hướng dẫn trực quan</p>
                                </div>
                                <div class="team-block-image-wrap1">
                                    <img src="images/Poster.jpg" class="team-block-image img-fluid" alt="">
                                </div>
                            </div>
                        </a>
                    </div>

                </div>
            </div>

            <div class="container">
                <div class="row justify-content-start">

                    <div class="col-lg-12 col-12 text-center mb-4 pb-lg-2">
                        <h2 class="text-white3">Kit 3: Chăm sóc khách hàng</h2>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://www.canva.com/design/DAGpHzJ2mdE/XviFn0AVBHwqoTNB4Z5YZg/view" target="_blank" style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Thư cám ơn</h4>
                                    </div>
                                    <p class="text-white mb-0">Tri ân – gắn kết bền lâu</p>
                                </div>
                                <div class="team-block-image-wrap1">
                                    <img src="images/Thiệp cảm ơn.png"
                                        class="team-block-image img-fluid" alt="">
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://www.canva.com/design/DAGpcW_zKXQ/DZqGVfw32QRUX10nxdcuBQ/view" target="_blank"
                            style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Thiệp sinh nhật</h4>
                                    </div>
                                    <p class="text-white mb-0">Dấu ấn dịp đặc biệt </p>
                                </div>
                                <div class="team-block-image-wrap1">
                                    <img src="images/Black And Gold Elegant Birthday Party Celebration Instagram Post.png" class="team-block-image img-fluid" alt="">
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="col-lg-3 col-md-6 col-12 mb-4">
                        <a href="https://www.canva.com/design/DAGqIx39lqI/tnSvHRvFp-R9M2SlSm721A/view" target="_blank"
                            style="text-decoration: none;">
                            <div class="team-block-wrap1">
                                <div class="team-block-info1 d-flex flex-column">
                                    <div class="d-flex mt-auto mb-3">
                                        <h4 class="text-white mb-0">Quà tặng</h4>
                                    </div>
                                    <p class="text-white mb-0">Điều bất ngờ – tăng sự gắn bó</p>
                                </div>
                                <div class="team-block-image-wrap1">
                                    <img src="images/Chúc quý khách và gia đình một mùa Trăng tròn trọn vẹn yêu thương (1).png" class="team-block-image img-fluid" alt="">
                                </div>
                            </div>
                        </a>
                    </div>

                </div>
            </div>

        </section>


        <footer class="site-footer">
            <div class="container">
                <div class="row">

                    <div class="col-lg-4 col-12 me-auto">
                        <em class="text-white d-block mb-4">Where to find us?</em>

                        <strong class="text-white">
                            <i class="bi-geo-alt me-2"></i>
                            Trụ sở chính: 54A Nguyễn Chí Thanh, Quận Đống Đa, Hà Nội
                        </strong>

                        <ul class="social-icon mt-4">
                            <li class="social-icon-item">
                                <a href="https://www.facebook.com/MSBVietnam" class="social-icon-link bi-facebook">
                                </a>
                            </li>

                            <li class="social-icon-item">
                                <a href="https://www.linkedin.com/company/msbcareer" target="_new"
                                    class="social-icon-link bi-linkedin">
                                </a>
                            </li>

                            <li class="social-icon-item">
                                <a href="https://www.youtube.com/@MSBVietnam/featured"
                                    class="social-icon-link bi-youtube">
                                </a>
                            </li>

                        </ul>
                    </div>

                    <div class="col-lg-3 col-12 mt-4 mb-3 mt-lg-0 mb-lg-0">
                        <em class="text-white d-block mb-4">Contact</em>

                        <p class="d-flex mb-1">
                        <div class="footer-hotline d-flex flex-column">
                            <div class="d-flex">
                                <strong class="me-2">Hotline:</strong>
                                <div>
                                    <a href="tel:1800599999" class="site-footer-link">
                                        1800 599 999 (miễn phí)
                                    </a><br>
                                    <a href="tel:+842439445566" class="site-footer-link ms-0">
                                        +84 2439 445 566 (quốc tế)
                                    </a>
                                </div>
                            </div>
                        </div>
                        </p>

                        <p class="d-flex">
                            <strong class="me-2">Email:</strong>

                            <a href="mailto:mfirst247@msb.com.vn" class="site-footer-link">
                                mfirst247@msb.com.vn
                            </a>
                        </p>
                    </div>


                    <div class="col-lg-5 col-12">
                        <em class="text-white d-block mb-4">Opening Hours.</em>

                        <ul class="opening-hours-list">
                            <li class="d-flex">
                                Monday - Friday
                                <span class="underline"></span>

                                <strong>8:00 - 17:00</strong>
                            </li>

                            <li class="d-flex">
                                Saturday
                                <span class="underline"></span>

                                <strong>8:00 - 12:00</strong>
                            </li>

                            <li class="d-flex">
                                Sunday
                                <span class="underline"></span>

                                <strong>Closed</strong>
                            </li>
                        </ul>
                    </div>

                    <div class="col-lg-8 col-12 mt-4">
                        <p class="copyright-text mb-0">Designed and Developed by Chuongnq3 - RDM</p>
                    </div>
                </div>
        </footer>
    </main>

    <!-- Chatbot UI -->
    <!-- Nút mở chatbot (icon avatar) -->
    <div id="chatbot-toggle">
        <img src="images/icons8-ai-chatting-100.png" alt="Chatbot Icon">
    </div>

    <!-- Khung chatbot -->
    <div id="chatbot-container" class="hidden">
        <div id="chatbot-header">
            MSB – Hỗ trợ mọi lúc mọi nơi
            <span id="chatbot-close">×</span>
        </div>
        <div id="chatbot-messages"></div>
        <form id="chatbot-form">
            <input type="text" id="chatbot-input" placeholder="Nhập tin nhắn..." />
            <button type="submit" id="chatbot-send-btn">
                <img src="images/Send.png" alt="Gửi" />
            </button>
        </form>

    </div>

    <!-- JAVASCRIPT FILES -->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.sticky.js"></script>
    <script src="js/click-scroll.js"></script>
    <script src="js/vegas.min.js"></script>
    <script src="js/custom.js"></script>
    <script src="js/marked.min.js"></script>


    <!-- <script>
            // // B1: Tải nội dung chính sách (async + cache sẵn)
            // let productPolicyPromise = fetch("product-policy.txt")
            //     .then(res => {
            //         if (!res.ok) throw new Error("Không thể tải file chính sách.");
            //         return res.text();
            //     })
            //     .catch(err => {
            //         console.error("Lỗi khi tải chính sách:", err);
            //         return "";
            //     });

            // B2: Mở chatbot
            document.getElementById("chatbot-toggle").addEventListener("click", () => {
                document.getElementById("chatbot-container").classList.remove("hidden");
                document.getElementById("chatbot-toggle").style.display = "none";

                const messages = document.getElementById("chatbot-messages");
                if (messages.children.length === 0) {
                    appendMessage("AI-RDM", "Xin chào, mình là AI-RDM! Mình có thể giúp gì cho bạn?");
                }
            });

            // B3: Đóng chatbot
            document.getElementById("chatbot-close").addEventListener("click", () => {
                document.getElementById("chatbot-container").classList.add("hidden");
                document.getElementById("chatbot-toggle").style.display = "flex";
            });

            // B4: Xử lý gửi câu hỏi
            // Ghi nhớ lịch sử hội thoại
            let messages = [
            {
                role: "system",
                content: `
                BIỂU PHÍ THẺ TÍN DỤNG MSB MASTERCARD WORLD ELITE (áp dụng từ 26/03/2025)

                1. LÃI SUẤT
                - Lãi suất chi tiêu/tháng: 3%
                - Lãi suất rút tiền mặt tại ATM/tháng: 3%
                - Lãi suất chậm trả/năm: 145% lãi suất trong hạn
                - Lãi suất trả góp: Theo chính sách từng thời kỳ

                2. PHÍ PHÁT HÀNH & THƯỜNG NIÊN
                - Phí phát hành thẻ chính: 2.000.000 đồng
                - Phí thường niên thẻ chính: 15.000.000 đồng

                3. PHÍ GIAO DỊCH
                - Rút tiền tại ATM: 4% số tiền, tối thiểu 50.000 đồng
                - Truy vấn số dư tại ATM: 5.000 đồng/lần
                - Giao dịch ngoại tệ: Miễn phí

                4. PHÍ DỊCH VỤ KHÁC
                - Thay thẻ bị mất: 2.000.000 đồng
                - Thay thẻ hết hạn: Miễn phí
                - Cấp lại PIN: Miễn phí
                - Khiếu nại sai: 500.000 đồng/lần
                - Bản sao sao kê/hóa đơn: 100.000 đồng/bản
                - Dịch vụ khác: 100.000 đồng/lần
                - Phí chậm trả: 5% số tiền, tối thiểu 500.000 đồng
                - Thay đổi hạng thẻ: 100.000 đồng + phí thường niên mới
                - Đóng thẻ trước hạn: 5.000.000 đồng
                - Thông báo biến động số dư SMS: Miễn phí
                `
            }
            ];

            // B4: Xử lý gửi câu hỏi
            document.getElementById("chatbot-form").addEventListener("submit", async function (e) {
            e.preventDefault();
            const input = document.getElementById("chatbot-input");
            const message = input.value.trim();
            if (!message) return;

            appendMessage("Bạn", message);
            input.value = "";
            
            // // Chờ policy load xong
            // const productPolicy = await productPolicyPromise;
            // if (!productPolicy) {
            //     appendMessage("AI-RDM", "Đang tải dữ liệu sản phẩm, vui lòng thử lại sau.");
            //     return;
            // }  

            // ✅ Thêm vào mảng lịch sử hội thoại
            messages.push({ role: "user", content: message });

            //console.log(messages);
            appendLoadingMessage();

            fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer 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" // <-- Thay bằng key thật
                },
                body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: messages,
                temperature: 0.7
                })
            })
                .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
                })
                .then(data => {
                document.getElementById("loading-message")?.remove();    
                const reply = data.choices?.[0]?.message?.content?.trim();
                if (reply) {
                    appendMessage("AI-RDM", reply);

                    // ✅ Thêm phản hồi vào lịch sử
                    messages.push({ role: "assistant", content: reply });
                } else {
                    appendMessage("AI-RDM", "Xin lỗi, hiện tại mình chưa có câu trả lời.");
                }
                })
                .catch(err => {
                    document.getElementById("loading-message")?.remove();
                    console.error("Lỗi:", err);
                    appendMessage("AI-RDM", "Đã xảy ra lỗi khi kết nối đến GPT.");
                });
            });


            // B5: Hàm hiển thị tin nhắn
            function appendMessage(sender, text) {
                const msgWrapper = document.createElement("div");
                msgWrapper.classList.add("chat-message-wrapper");

                if (sender === "AI-RDM") {
                    msgWrapper.classList.add("bot");
                    msgWrapper.innerHTML = `
                        <div style="display: flex; align-items: flex-start;">
                            <img src="images/icons8-ai-chatting-100.png" alt="Bot Avatar"
                                style="width: 32px; height: 32px; border-radius: 50%; margin-right: 8px;">
                            <div class="chat-message bot">${text}</div>
                        </div>`;
                } else {
                    msgWrapper.classList.add("user");
                    msgWrapper.innerHTML = `
                        <div class="chat-message user">${text}</div>`;
                }

                const messages = document.getElementById("chatbot-messages");
                messages.appendChild(msgWrapper);
                messages.scrollTop = messages.scrollHeight;
            }

            function appendLoadingMessage() {
                const msgWrapper = document.createElement("div");
                msgWrapper.classList.add("chat-message-wrapper", "bot");
                msgWrapper.setAttribute("id", "loading-message");

                msgWrapper.innerHTML = `
                    <div style="display: flex; align-items: flex-start;">
                        <img src="images/icons8-ai-chatting-100.png" alt="Bot Avatar"
                            style="width: 32px; height: 32px; border-radius: 50%; margin-right: 8px;">
                        <div class="chat-message bot typing">...</div>
                    </div>`;

                const messages = document.getElementById("chatbot-messages");
                messages.appendChild(msgWrapper);
                messages.scrollTop = messages.scrollHeight;
            }

        </script> -->

    <!-- <script>
        const assistant_id = "asst_ZRPcnjQrPo38gbph1YHXDknt"; // 🔁 Thay bằng assistant thật
        const file_ids = [
            "file-Qpo1C7bghFKXPC3P5EMDNC",
            "file-BZ6eUFduEfAQm4Nj8qNWDB",
            "file-CsviP5uwrQrNftPHheCTwz",
            "file-2RsHApc5XUBaU8ViiXV9f2"
        ];
        const apiKey = "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"; // 🔁 Thay bằng API key thật

        let thread_id = localStorage.getItem("thread_id");
        if (thread_id === "undefined" || !thread_id) {
        thread_id = null;
        }

        function resetThread() {
        localStorage.removeItem("thread_id");
        thread_id = null;
        }

        window.onload = () => {
        resetThread(); // Reset thread mỗi khi F5
        };

        document.getElementById("chatbot-toggle").addEventListener("click", () => {
            document.getElementById("chatbot-container").style.display = "flex";
            document.getElementById("chatbot-toggle").style.display = "none";

            const messages = document.getElementById("chatbot-messages");
            if (messages.children.length === 0) {
                appendMessage("AI-RDM", "Xin chào, mình là AI-RDM! Mình có thể giúp gì cho bạn?");
            }
        });

        document.getElementById("chatbot-close").addEventListener("click", () => {
            document.getElementById("chatbot-container").style.display = "none";
            document.getElementById("chatbot-toggle").style.display = "inline-block";
        });

        document.getElementById("chatbot-form").addEventListener("submit", async function (e) {
            e.preventDefault();
            const input = document.getElementById("chatbot-input");
            const message = input.value.trim();
            if (!message) return;

            appendMessage("Bạn", message);
            input.value = "";
            appendLoadingMessage();

            const reply = await sendMessageToAssistant(message);
            document.getElementById("loading-message")?.remove();
            appendMessage("AI-RDM", reply);
        });

        async function sendMessageToAssistant(userMessage) {
            try {
                if (!thread_id) {
                    // B1: Tạo thread trống
                    const threadRes = await fetch("https://api.openai.com/v1/threads", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`,
                        "OpenAI-Beta": "assistants=v2"
                    },
                    body: JSON.stringify({})
                    });

                    const threadData = await threadRes.json();
                    if (!threadRes.ok || !threadData.id) {
                    throw new Error("Không thể tạo thread mới: " + JSON.stringify(threadData));
                    }

                    thread_id = threadData.id;
                    localStorage.setItem("thread_id", thread_id);

                    // B2: Gửi message chứa file_ids
                    await fetch(`https://api.openai.com/v1/threads/${thread_id}/messages`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`,
                        "OpenAI-Beta": "assistants=v2"
                    },
                    body: JSON.stringify({
                        role: "user",
                        content: userMessage,
                        file_ids: file_ids
                    })
                    });
                } else {
                    await fetch(`https://api.openai.com/v1/threads/${thread_id}/messages`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${apiKey}`,
                            "OpenAI-Beta": "assistants=v2"
                        },
                        body: JSON.stringify({
                            role: "user",
                            content: userMessage
                        })
                    });
                }

                const runRes = await fetch(`https://api.openai.com/v1/threads/${thread_id}/runs`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`,
                        "OpenAI-Beta": "assistants=v2"
                    },
                    body: JSON.stringify({
                        assistant_id: assistant_id
                    })
                });

                const runData = await runRes.json();
                const run_id = runData.id;

                let runStatus = "in_progress";
                while (runStatus === "in_progress" || runStatus === "queued") {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const checkRes = await fetch(`https://api.openai.com/v1/threads/${thread_id}/runs/${run_id}`, {
                        headers: {
                            Authorization: `Bearer ${apiKey}`,
                            "OpenAI-Beta": "assistants=v2"
                        }
                    });
                    const checkData = await checkRes.json();
                    runStatus = checkData.status;
                }

                const msgRes = await fetch(`https://api.openai.com/v1/threads/${thread_id}/messages`, {
                    headers: {
                        Authorization: `Bearer ${apiKey}`,
                        "OpenAI-Beta": "assistants=v2"
                    }
                });

                const msgData = await msgRes.json();
                const lastMessage = msgData.data.find(m => m.role === "assistant");
                return lastMessage?.content?.[0]?.text?.value || "Không có phản hồi.";
            } catch (err) {
                console.error("Lỗi Assistant API:", err);
                return "Đã xảy ra lỗi khi kết nối GPT.";
            }
        }

        function appendMessage(sender, text) {
            const msgWrapper = document.createElement("div");
            msgWrapper.classList.add("chat-message-wrapper");

            if (sender === "AI-RDM") {
                msgWrapper.classList.add("bot");
                msgWrapper.innerHTML = `
                    <div style="display: flex; align-items: flex-start;">
                        <img src="images/icons8-ai-chatting-100.png" alt="Bot Avatar"
                            style="width: 32px; height: 32px; border-radius: 50%; margin-right: 8px;">
                        <div class="chat-message bot">${text}</div>
                    </div>`;
            } else {
                msgWrapper.classList.add("user");
                msgWrapper.innerHTML = `
                    <div class="chat-message user">${text}</div>`;

            }

            const messages = document.getElementById("chatbot-messages");
            messages.appendChild(msgWrapper);
            messages.scrollTop = messages.scrollHeight;
        }

        function appendLoadingMessage() {
            const msgWrapper = document.createElement("div");
            msgWrapper.classList.add("chat-message-wrapper", "bot");
            msgWrapper.setAttribute("id", "loading-message");
            msgWrapper.innerHTML = `<div class="chat-message bot">Đang soạn...</div>`;

            const messages = document.getElementById("chatbot-messages");
            messages.appendChild(msgWrapper);
            messages.scrollTop = messages.scrollHeight;
        }
    </script> -->

    <script>
        /* ———— CONFIG ———— */
        const assistant_id = "asst_ZRPcnjQrPo38gbph1YHXDknt"; // 🔁 Thay bằng assistant thật
        const file_ids = [
            "file-Qpo1C7bghFKXPC3P5EMDNC",
            "file-UBuhfJGuKz2FP5CGYVaxZ3",
            "file-2DhFpmmptFfSgQdeN7emuu",
            "file-4f7CKN8QDa2qrVWYWvsmqp"
        ];
        const apiKey = "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"; // 🔁 Thay bằng API key thật

        /* ———— STATE ———— */
        let thread_id = localStorage.getItem("thread_id") || null;

        /* ———— HELPERS ———— */
        function scrollMessages() {
            const m = document.getElementById("chatbot-messages");
            m.scrollTop = m.scrollHeight;
        }
        // function appendMessage(sender, rawText) {
        //     const wrap = document.createElement("div");
        //     wrap.className = `chat-message-wrapper ${sender === "AI" ? "bot" : "user"}`;

        //     // 1) Bỏ marker trích dẫn nếu không cần
        //     let html = rawText.replace(/【\d+:\d+†source】/g, "");

        //     // 2) Thay \n thành <br> để giữ xuống dòng
        //     html = html.replace(/\n/g, "<br>");

        //     wrap.innerHTML = `<div class="chat-message">${html}</div>`;

        //     console.log(wrap);
        //     document.getElementById("chatbot-messages").appendChild(wrap);
        //     scrollMessages();
        // }

        function appendMessage(sender, rawText) {
            const wrap = document.createElement("div");
            wrap.className = `chat-message-wrapper ${sender === "AI" ? "bot" : "user"}`;

            // 1. Xoá marker nguồn
            const cleaned = rawText.replace(/【\d+:\d+†source】/g, "");

            // 2. Thay \n bằng markdown-compatible xuống dòng
            const withLineBreak = cleaned.replace(/\n/g, '  \n');

            // 3. Dùng marked.parseInline để không sinh <p>
            let html;
            try {
                html = marked.parseInline(withLineBreak);

                // 4. Nếu Markdown vẫn không render xuống dòng, ép bằng <br>
                if (!html.includes('<br>')) {
                    html = html.replace(/\n/g, '<br>');
                }
            } catch (e) {
                html = cleaned.replace(/\n/g, "<br>");
            }

            // 5. Gắn vào chat
            wrap.innerHTML = `<div class="chat-message ${sender === "AI" ? "bot" : "user"}">${html}</div>`;
            document.getElementById("chatbot-messages").appendChild(wrap);
            scrollMessages();
        }


        function appendLoading() {
            const id = "loading-msg";
            const wrap = document.createElement("div");
            wrap.id = id; wrap.className = "chat-message-wrapper bot";
            wrap.innerHTML = `<div class="chat-message">Đang soạn…</div>`;
            document.getElementById("chatbot-messages").appendChild(wrap);
            scrollMessages();
        }

        /* ———— OPEN / CLOSE ———— */
        document.getElementById("chatbot-toggle").onclick = () => {
            document.getElementById("chatbot-container").style.display = "flex";
            document.getElementById("chatbot-toggle").style.display = "none";
            if (!document.querySelector(".bot")) appendMessage("AI", "Xin chào, mình là AI‑RDM! Mình có thể giúp gì cho bạn?");
        };
        document.getElementById("chatbot-close").onclick = () => {
            document.getElementById("chatbot-container").style.display = "none";
            document.getElementById("chatbot-toggle").style.display = "flex";
        };

        /* ———— MAIN SEND ———— */
        document.getElementById("chatbot-form").addEventListener("submit", async e => {
            e.preventDefault();
            const input = document.getElementById("chatbot-input");
            const text = input.value.trim();
            if (!text) return;
            appendMessage("user", text);
            input.value = "";
            appendLoading();
            const answer = await sendMessage(text);
            document.getElementById("loading-msg")?.remove();
            appendMessage("AI", answer);
        });

        async function sendMessage(userText) {
            try {
                /* 1️⃣  Nếu chưa có thread thì tạo mới */
                if (!thread_id) {
                    const res = await fetch("https://api.openai.com/v1/threads", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKey}`, "OpenAI-Beta": "assistants=v2" },
                        body: JSON.stringify({})
                    });
                    const data = await res.json();
                    thread_id = data.id;
                    localStorage.setItem("thread_id", thread_id);
                }

                /* 2️⃣  Tạo message — lần ĐẦU cần đính kèm file */
                const attachments = (!localStorage.getItem("sent_first")) ?
                    file_ids.map(id => ({ file_id: id, tools: [{ type: "file_search" }] })) : [];

                const msgRes = await fetch(`https://api.openai.com/v1/threads/${thread_id}/messages`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKey}`, "OpenAI-Beta": "assistants=v2" },
                    body: JSON.stringify({ role: "user", content: userText, attachments })
                });
                if (!localStorage.getItem("sent_first")) localStorage.setItem("sent_first", "1");

                /* 3️⃣  Tạo run */
                const runRes = await fetch(`https://api.openai.com/v1/threads/${thread_id}/runs`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKey}`, "OpenAI-Beta": "assistants=v2" },
                    body: JSON.stringify({ assistant_id, instructions: "Trả lời ngắn gọn, đúng số liệu, bằng tiếng Việt." })
                });
                const { id: run_id } = await runRes.json();

                /* 4️⃣  Poll tới khi xong */
                while (true) {
                    await new Promise(r => setTimeout(r, 1000));
                    const check = await fetch(`https://api.openai.com/v1/threads/${thread_id}/runs/${run_id}`, {
                        headers: { Authorization: `Bearer ${apiKey}`, "OpenAI-Beta": "assistants=v2" }
                    });
                    const { status } = await check.json();
                    if (status === "completed") break;
                    if (["failed", "cancelled"].includes(status)) throw new Error("Run failed: " + status);
                }

                /* 5️⃣  Lấy tin nhắn mới nhất của assistant */
                const msgList = await fetch(`https://api.openai.com/v1/threads/${thread_id}/messages?limit=1`, {
                    headers: { Authorization: `Bearer ${apiKey}`, "OpenAI-Beta": "assistants=v2" }
                });
                const { data } = await msgList.json();
                return data?.[0]?.content?.[0]?.text?.value || "Xin lỗi, mình chưa có thông tin.";
            } catch (err) {
                console.error(err);
                return "Đã xảy ra lỗi khi kết nối GPT.";
            }
        }
    </script>

</body>

</html>
